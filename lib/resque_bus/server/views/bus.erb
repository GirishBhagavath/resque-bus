
<script LANGUAGE="JavaScript">
<!--
function confirmSubmit()
{
var agree=confirm("Are you sure you wish to continue?");
if (agree)
	return true ;
else
	return false ;
}
// -->
</script>

<%
  app_hash = {}
  event_hash = {}
  
  # collect each differently
  ResqueBus::Application.all.each do |app|
    app_key = app.app_key
    
    app_hash[app_key] ||= []
    app.event_display_tuples.each do |tuple|
      event, queue = tuple
      app_hash[app_key] << [event, queue]
      
      event_hash[event] ||= []
      event_hash[event] << [app_key, queue]
    end
  end
  
  # sort each list item by secondary label
  event_hash.each do |_, array|
    array.sort!{ |a,b| a.first <=> b.first }
  end
  event_hash.each do |_, array|
    array.sort!{ |a,b| a.first <=> b.first }
  end
  
  # helper to display either
  def display_row(name, val, button=nil, first=false)
    form = ""
    if button
      text, url = button
      form = "<form method='POST' action='#{u url}' style='float:left; padding:0 5px 0 0;margin:0;'><input type='submit' name='' value='#{text}' style='padding:0;margin:0;' onclick=\"return confirmSubmit();\"/><input type='hidden' name='name' value='#{h(name)}' /></form>"
    end
    
    if !val
      out = "<td>&nbsp;</td><td>&nbsp;</td>"
    else
      detail, queue = val
      out = "<td>#{h(detail)}</td><td><a href='#{u("queues/#{queue}")}'>#{h(queue)}</a></td>"
    end
    
    if first
      "<tr><td>#{h(name)}#{form}</td>#{out}</tr>\n"
    else
      "<tr><td>&nbsp;</td>#{out}</tr>\n"
    end
  end
  
  def output_hash(hash, action=nil)
    out = ""
    hash.keys.sort.each do |item|
      display = hash[item]
      first = display.shift
      out << display_row(item, first, action, true)
      display.each do |val|
        out << display_row(item, val, action)
      end
    end
    out
  end
%>



<h1 class='wi'>Applications</h1>
<p class='intro'>The apps below have registered the given event types and queues.</p>
<table class='queues'>
  <tr>
    <th>App Key</th>
    <th>Event Type</th>
    <th>Queue</th>
  </tr>
  <%= output_hash(app_hash, ["Unsubscribe", "bus/unsubscribe"]) %>
</table>

<p>&nbsp;</p>
  
<h1 class='wi'>Events</h1>
<p class='intro'>The event types below have been registered by the given applications and queues.</p>
<table class='queues'>
  <tr>
    <th>Event Type</th>
    <th>App Key</th>
    <th>Queue</th>
  </tr>
  <%= output_hash(event_hash, false) %>
</table>
